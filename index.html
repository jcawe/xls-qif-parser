<!DOCTYPE html>
<html lang="en">

<head>
  <title>XLS QIF CONVERTER</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/css/materialize.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/js/materialize.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
  <nav>
    <div class="nav-wrapper">
      <a class="brand-logo center">XLS QIF Converter</a>
    </div>
  </nav>
  <div class="center">
    <form>
      <div id="form-buttons" class="scale-transition">
        <fieldset>
          <div class="file-field input-field">
            <div id="btnExcel" class="btn waves-effect waves-light btn-floating pulse">
              <i class="material-icons small">attachment</i>
            </div>

            <div class="file-path-wrapper">
              <input id="excel-file" type="text" class="file-path validate" placeholder="Select a excel file">
            </div>
          </div>

          <div class="file-field input-field">
            <div id="btnQif" class="btn waves-effect waves-light btn-floating pulse">
              <i class="material-icons small">attachment</i>
            </div>

            <div class="file-path-wrapper">
              <input id="qif-file" type="text" class="file-path validate" placeholder="Select path to save qif file">
            </div>
          </div>

          <button id="btnConvert" type="submit" class="waves-effect waves-light btn-large disabled">
            Convert
            <i class="material-icons right">autorenew</i>
          </button>
        </fieldset>
        <a id="btnQif" class="waves-effect waves-light btn-large disabled" onclick="selectQif()">Select save location...</a>
      </div>
    </form>

    <div id="error" class="card-panel center red darken-1 hide scale-transition scale-out white-text">
      <h2 class="card-title">
        <i class="medium material-icons">error</i>ERROR!</h2>
      <p id="errorText"></p>
      <a onclick="reload()" class="btn-floating pulse red">
        <i class="material-icons">refresh</i>
      </a>
    </div>

    <div id="success" class="card-panel center teal darken-1 hide scale-transition scale-out white-text">
      <h2 class="card-title">
        <i class="medium material-icons">check</i>SUCCESS!</h2>
      <p>File converted successfully!</p>
      <a onclick="reload()" class="btn-floating pulse">
        <i class="material-icons">refresh</i>
      </a>
    </div>
  </div>

  <script>
    const electron = require('electron');
    const { ipcRenderer } = electron;
    const form = document.getElementsByTagName("form")[0];
    const btnExcel = document.getElementById("btnExcel");
    const btnQif = document.getElementById("btnQif");
    const btnConvert = document.getElementById("btnConvert");
    const loader = document.getElementById("loader");
    const formButtons = document.getElementById("form-buttons");
    const excelFile = document.getElementById("excel-file");
    const qifFile = document.getElementById("qif-file");

    form.addEventListener("submit", convert, false);
    excelFile.addEventListener("change", function() {
      ipcRenderer.send("path:excel", this.value);
    }, false);

    btnQif.addEventListener("click", function(e) {
      e.preventDefault();
      ipcRenderer.send("btn:selectQif");
    }, false);

    btnExcel.addEventListener("click", function(e) {
      e.preventDefault();
      ipcRenderer.send("btn:selectExcel");
    }, false);

    function convert(e) {
      e.preventDefault();
      formButtons.classList.add("scale-out");
      ipcRenderer.send("btn:convert", excelFile.value, qifFile.value);
    }

    ipcRenderer.on("btn:excel", function (e, active) {
      focusButton(btnExcel, active);
      checkInputs();
    });
    
    ipcRenderer.on("btn:qif", function (e, active) {
      focusButton(btnQif, active);
    });
    
    ipcRenderer.on("path:excel", function (e, filename) {
      excelFile.value = filename;
      if(filename !== "") excelFile.classList.add("valid");
      else excelFile.classList.remove("valid");
      checkInputs();
    });
    
    ipcRenderer.on("path:qif", function (e, filename) {
      qifFile.value = filename;
      if(filename !== "") qifFile.classList.add("valid");
      else qifFile.classList.remove("valid");
      checkInputs();
    });

    function checkInputs(){
      var active = qifFile.value !== "" && excelFile.value !== "";
      activateButton(btnConvert, active);
      focusButton(btnConvert, active);
    }
    ipcRenderer.on("error", function (e, error) {
      document.getElementById("errorText").textContent = error;
      document.getElementById("error").classList.remove("hide");
      document.getElementById("error").classList.add("scale-in");
      formButtons.classList.add("hide");
    });

    ipcRenderer.on("success", function () {
      document.getElementById("success").classList.remove("hide");
      document.getElementById("success").classList.add("scale-in");
      formButtons.classList.add("hide");
    });

    function focusButton(button, active){
      if (active) button.classList.add("pulse");
      else button.classList.remove("pulse");
    }

    function activateButton(button, active) {
      if (active) button.classList.remove("disabled");
      else button.classList.add("disabled");
    }

    function reload() {
      location.reload();
    }
  </script>
</body>

</html>